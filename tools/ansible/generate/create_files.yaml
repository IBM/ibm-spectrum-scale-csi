---

- name: "delete the directory {{ generated_dir }}"
  file:
    path: "{{ generated_dir }}"
    state: absent
  when: not travis_testing

- name: "create the directory {{ generated_dir }}"
  file:
    path: "{{ generated_dir }}"
    state: directory
    mode: '0755'

- name: Add a comment line to the file to indicate generated
  lineinfile:
    path: "{{ generated_op_yaml }}"
    line: "# DO NOT MODIFY - generated by ansible/generate-playbook.yaml - DO NOT MODIFY"
    create: yes

- name: "Combining the individual deploy/*yaml files into a single one: {{ generated_op_yaml }}"
  blockinfile:
    marker: "# {mark} {{ item.name }}"
    dest: "{{ generated_op_yaml }}"
    block: "{{ lookup('file', '{{ operator_dir }}/{{ item.name }}') }}"
    state: present
    create: yes
  with_items:
    - "{{ operator_files }}"

- name: "Use lineinfile to add a unique tag between the markers from block in file"
  lineinfile:
    dest: "{{ generated_op_yaml }}"
    insertafter: '\# END {{ item.name }}'
    state: present
    line: "REPLACE_WITH_DASHES {{ item.name }}"
  with_items: 
    - "{{ operator_files }}"

- name: "Replace all of the REPLACE_WITH_DASHS to be ---, to correctly separate the blocks"
  replace:
    path: "{{ generated_op_yaml }}"
    regexp: 'REPLACE_WITH_DASHES.*'
    replace: '---'

- name: copy over the files that are not modified
  copy:
    src: "{{ operator_dir }}/{{ item }}"
    dest: "{{ generated_dir }}"
  with_items: 
    - "deploy/namespace.yaml"
    - "deploy/crds/csiscaleoperators.csi.ibm.com.crd.yaml"
  when: non_generated

- name: "[Testing] Comparing the generated operator file with checked in code ..."
  shell: "diff {{ generated_dir }}/ibm-spectrum-scale-csi-operator.test.yaml {{ generated_dir }}/ibm-spectrum-scale-csi-operator.yaml"
  ignore_errors: yes
  register: diff_output
  when: travis_testing|bool

- name: "[Testing] Diff standard out"
  debug:
    msg: "{{ diff_output.stdout }}"
  when: travis_testing|bool

- name: "[Testing] Diff standard error"
  debug:
    msg: "{{ diff_output.stderr }}"
  when: travis_testing|bool

- name: "[Testing] Failure Message"
  fail:
    msg: "The generated ibm-spectrum-scale-csi-operator.yaml did not match the deploy yaml files, did you forget to check it in?"
  when:
    - travis_testing|bool
    - "diff_output.rc != 0"